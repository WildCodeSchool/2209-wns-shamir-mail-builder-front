name: jest-docker-ci

on: push

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: Launch jest tests
        run: npm i && npm run test

  docker:
    needs: test
    if: github.ref == 'refs/heads/main'

    runs-on: ubuntu-latest
    steps:
      - name: SET UP QEMU
        uses: docker/setup-qemu-action@v2
      - name: SET UP DOCKER BUILDx
        uses: docker/setup-buildx-action@v2
      - name: LOGIN TO DOCKER HUB
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: CHECKOUT CODE
        uses: actions/checkout@v2
      - name: dot env creation
        if: ${{ success() }}
        run: |
          echo "${{secrets.DOT_ENV}}" > .env
      - name: BUILD AND PUSH
        if: ${{ success() }}
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/mailsaw:latest -f Dockerfile.prod .
          docker push ${{ secrets.DOCKER_USERNAME }}/mailsaw:latest
          
